<Window x:Class="Synapse.Crypto.Patterns.SimulatorWnd"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:xb="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:sp="clr-namespace:ScottPlot.WPF;assembly=ScottPlot.WPF"
        xmlns:bb="clr-namespace:Synapse.Crypto.Bybit;assembly=Synapse.Crypto.Bybit"
        xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
        xmlns:hc="https://handyorg.github.io/handycontrol"
        xmlns:local="clr-namespace:Synapse.Crypto.Patterns"
        mc:Ignorable="d"
        Title="SimulatorWnd" Height="450" Width="800">

    <xb:Interaction.Triggers>
        <xb:EventTrigger EventName="Loaded">
            <xb:CallMethodAction MethodName="OnLoaded" TargetObject="{Binding}"/>
        </xb:EventTrigger>
        <xb:EventTrigger EventName="Unloaded">
            <xb:CallMethodAction MethodName="OnUnloaded" TargetObject="{Binding}"/>
        </xb:EventTrigger>
        <xb:EventTrigger EventName="Closing">
            <xb:CallMethodAction MethodName="OnClosing" TargetObject="{Binding}"/>
        </xb:EventTrigger>
    </xb:Interaction.Triggers>

    <Window.Resources>

        <ObjectDataProvider x:Key="formations" MethodName="GetValues" ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="local:TradeFormations"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="rngintervals" MethodName="GetValues" ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="local:RangeIntervals"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="breakstyles" MethodName="GetValues" ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="local:BreakStyles"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="timeFrames" MethodName="GetValues" ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="bb:TimeFrames"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="chartTypes" MethodName="GetValues" ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="local:ChartTypes"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <local:RangeIntervalBoolConverter x:Key="RangeIntervalBoolConv"/>

    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        <Grid x:Name="chartGrid" HorizontalAlignment="Stretch" Cursor="">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            <ToolBar>
                <ComboBox Margin="5,2" Width="80" ItemsSource="{Binding Source={StaticResource timeFrames}}"
                          SelectedItem="{Binding TimeFrame}" ToolTip="Интервал"/>
                <ComboBox Margin="5, 2" Width="100" ItemsSource="{Binding Source={StaticResource chartTypes}}"
                          SelectedItem="{Binding ChartType}" ToolTip="Тип графика"/>

                <Menu Width="32" Background="Transparent" >
                    <MenuItem>
                        <MenuItem.HeaderTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Image Source="/Resources/slash2_32.png" Height="17" Width="17" Margin="0,0,0,0"/>
                                </StackPanel>
                            </DataTemplate>
                        </MenuItem.HeaderTemplate>

                        <MenuItem Header="Lines">
                            <MenuItem Header="Horizontal line" Command="{Binding LinesCommand}" CommandParameter="horizontal" IsCheckable="True" 
                                  IsChecked="False" ToolTip="Нарисовать наклонную по двум свечам"/>
                            <MenuItem Header="Trend line" Command="{Binding LinesCommand}" CommandParameter="slope" IsCheckable="True" 
                                  IsChecked="False" ToolTip="Нарисовать линию тренда" />
                        </MenuItem>
                        <MenuItem Header="Ranges">
                            <MenuItem Header="One day" Command="{Binding RangeCommand}" CommandParameter="Day" IsCheckable="True" 
                                  IsChecked="{Binding RangeInterval, Converter={StaticResource RangeIntervalBoolConv}, ConverterParameter=Day}" />
                            <MenuItem Header="Three days" Command="{Binding RangeCommand}" CommandParameter="Three" IsCheckable="True"
                                  IsChecked="{Binding RangeInterval, Converter={StaticResource RangeIntervalBoolConv}, ConverterParameter=Three}" />
                            <MenuItem Header="Week" Command="{Binding RangeCommand}" CommandParameter="Week" IsCheckable="True"
                                  IsChecked="{Binding RangeInterval, Converter={StaticResource RangeIntervalBoolConv}, ConverterParameter=Week}" />
                            <MenuItem Header="Month" Command="{Binding RangeCommand}" CommandParameter="Month" IsCheckable="True"
                                  IsChecked="{Binding RangeInterval, Converter={StaticResource RangeIntervalBoolConv}, ConverterParameter=Month}" />
                            <Separator/>
                            <MenuItem Header="Clear" Command="{Binding RangeCommand}" CommandParameter="Clear" />
                        </MenuItem>
                    </MenuItem>
                </Menu>

                <ToggleButton ToolTip="Включить/выключить перекрестье" IsChecked="{Binding CrosshairOn}">
                    <Image Source="/Resources/crosshair_black_32.png" Height="18"/>
                </ToggleButton>
                
                <Separator/>

                <Button Command="{Binding DeleteElementCommand}" ToolTip="Удалить выбранный элемент" >
                    <Image Source="/Resources/recycling-bin.png" Height="18"/>
                </Button>

            </ToolBar>
            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                <local:CandleView VerticalAlignment="Center" DataContext="{Binding CandleViewModel}"/>
            </StackPanel>
            <sp:WpfPlot Grid.Row="2" Name="Plot"/>

        </Grid>
        <GridSplitter Grid.Column="1" VerticalAlignment="Stretch" HorizontalAlignment="Center" Width="5" Background="Gray"/>
        <Grid x:Name="infoGrid" Grid.Column="2" HorizontalAlignment="Stretch">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <Border Grid.Row="0" Margin="2" BorderBrush="Gray" BorderThickness="2" CornerRadius="2">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition/>
                        <RowDefinition/>
                        <RowDefinition/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="{Binding Time, StringFormat={}{0: dd.MM.yyyy HH:mm} }" VerticalAlignment="Center" HorizontalAlignment="Center" FontSize="14"  />
                    <StackPanel Grid.Row="1" Orientation="Horizontal">
                        <TextBlock Text="Старт:" Margin="5"/>
                        <TextBlock Text="{Binding StartTime}" Margin="5"/>
                        <xctk:SplitButton Margin="5">
                            <xctk:SplitButton.DropDownContent>
                                <StackPanel>
                                    <Button Content="Begin" Command="{Binding SetStartTimeCommand}" CommandParameter="Begin" Margin="5"/>
                                    <Button Content="Random" Command="{Binding SetStartTimeCommand}" CommandParameter="Random" Margin="5"/>
                                    <xctk:DateTimePicker Minimum="{Binding FirstTime}" Maximum="{Binding EndTime}" Value="{Binding StartTime}"/>
                                </StackPanel>
                            </xctk:SplitButton.DropDownContent>
                        </xctk:SplitButton>
                    </StackPanel>
                    <Button Grid.Row="2" Content="Начать" Command="{Binding StartCommand}" Margin="5">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Simulation}" Value="True">
                                        <Setter Property="Content" Value="Остановить"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </Grid>
            </Border>

            <local:SimulateTradingView Grid.Row="1" DataContext="{Binding Trading}"/>

            <!--<GroupBox Header="Формация" Grid.Row="1" Margin="2" BorderBrush="Gray" BorderThickness="2">
                <ComboBox ItemsSource="{Binding Source={StaticResource formations}}" SelectedItem="{Binding Formation}"
                                   Margin="5"/>
            </GroupBox> 

                <GroupBox Header="Торговля" Grid.Row="2" Margin="2" BorderBrush="Gray" BorderThickness="2" >
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Text="Price:" Margin="5,2" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="1" Text="{Binding Price}" Margin="5,2" VerticalAlignment="Center" ToolTip="Цена заявки (цена закрытия свечи)"/>
                    <TextBlock Grid.Column="2" Text="Vol:" VerticalAlignment="Center" Margin="5,2"/>
                    <xctk:DoubleUpDown Grid.Column="3" Value="{Binding Volume}" Margin="5,2" VerticalAlignment="Center" ToolTip="Объем заявки в USD"/>

                    <TextBlock Grid.Row="1" Text="SL" Margin="5,2" HorizontalAlignment="Right" />
                    <xctk:DoubleUpDown Grid.Row="1" Grid.Column="1" Value="{Binding StopLoss}" Margin="5,2" ToolTip="Стоп лосс"/>
                    <TextBlock Grid.Row="1" Grid.Column="2" Text="{Binding LossPer, StringFormat={}{0.00:%}}" Margin="5,2" ToolTip="Потенциальный % убытка на стопе" />
                    <xctk:IntegerUpDown Grid.Row="1" Grid.Column="3" Value="{Binding SLOffset}" Margin="5,2" ToolTip="Отступ от тени свечи в тиках"/>

                    <TextBlock Grid.Row="2" Text="TP" Margin="5,2" HorizontalAlignment="Right"/>
                    <xctk:DoubleUpDown Grid.Row="2" Grid.Column="1" Value="{Binding TakeProfit}" Margin="5,2" ToolTip="Тейк профит"/>
                    <TextBlock Grid.Row="2" Grid.Column="2" Text="{Binding ProfitPer, StringFormat={}{0.00:%}}" Margin="5,2" ToolTip="Потенциальная прибыль (%)" />
                    <xctk:DoubleUpDown Grid.Row="2" Grid.Column="3" Value="{Binding TakeStopRatio}"  Margin="5,2" ToolTip="Соотношение тейка к стопу"/>

                    <TextBlock Grid.Row="3" Text="Side:" Margin="5,2" HorizontalAlignment="Right"/>
                    <Button Grid.Row="3" Grid.Column="1" Grid.ColumnSpan="3" Content="{Binding Side}" Background="{Binding SideColor}" 
                            Command="{Binding ChangeSideCommand}" Margin="5,2" />
                    <Button Grid.Row="4" Grid.ColumnSpan="4" Content="Выполнить" Command="{Binding MakeTradeCommand}" Margin="5,2"/>
                </Grid>
            </GroupBox>-->

            <GroupBox Header="Навигация" Grid.Row="4" Margin="2" BorderBrush="Gray" BorderThickness="2">
                <Grid x:Name="navigationGrid" Margin="2" >
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <xctk:IntegerUpDown Value="{Binding Steps}" Minimum="1" Margin="2" Width="42" ToolTip="Шаг"  />
                    <ComboBox Grid.Column="1" Grid.ColumnSpan="2" ItemsSource="{Binding GoToItems}" SelectedItem="{Binding GoToItem}" Margin="2"
                       HorizontalAlignment="Stretch" ToolTip="Цель перемещения"  />
                    <Button Grid.Row="1" Grid.ColumnSpan="2"  Content="Next" Command="{Binding NextCommand}" Margin="2" />
                </Grid>
            </GroupBox>

        </Grid>
    </Grid>

</Window>
